<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Drag-and-Drop Calendar</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for grid and scrolling */
        #calendar {
            grid-template-columns: 80px repeat(7, 1fr); /* Wider time column */
            min-height: 800px;
            overflow-x: auto;
        }
        .time-slot {
            height: 50px; /* Uniform height for time slots */
        }
        .event-slot {
            min-height: 50px;
            /* Allow elements to stack vertically in a slot */
            display: flex;
            flex-direction: column; 
            padding: 2px;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div id="app-container" class="max-w-6xl w-full mx-auto shadow-2xl bg-white rounded-xl">
        <header class="p-6 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center">
                <span class="text-green-600">Scheduler</span> & Planner
            </h1>
        </header>

        <!-- Control Panel -->
        <div id="add-event" class="p-6 bg-gray-50 flex flex-col sm:flex-row gap-4">
            <input type="text" id="event-name" placeholder="Task Name (e.g., Design Review)" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 flex-grow text-sm">
            <input type="text" id="event-type" placeholder="Type (e.g., Work, Personal, Meeting)" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 flex-grow text-sm">
            <button onclick="addEvent()" class="p-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition duration-200">
                Create Task
            </button>
        </div>

        <!-- User Info & Status -->
        <div class="p-4 bg-yellow-100 text-yellow-800 text-sm font-medium border-t border-b border-yellow-200">
            User ID: <span id="user-id-display" class="font-mono">Loading...</span> 
            (Drag tasks to schedule them.)
        </div>

        <!-- Calendar Display -->
        <div id="calendar-container" class="p-4 overflow-x-auto">
            <div id="calendar" class="grid w-full gap-px bg-gray-300 rounded-md overflow-hidden">
                <!-- Calendar content generated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Modal for Confirmation/Alerts -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Alert</h3>
            <p class="text-gray-700 mb-6" id="modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 text-gray-800 hidden">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- GLOBAL CONFIGURATION (MANDATORY CANVAS VARIABLES) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-calendar-app';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let userId = null;
    let isAuthReady = false;
    
    // --- CALENDAR DATA STRUCTURES ---
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const times = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
    const calendar = document.getElementById('calendar');
    let unassignedTasks = []; 

    // --- UTILITY: MODAL FUNCTIONS (ALREADY WINDOW EXPOSED) ---
    // window.showAlert is already defined

    // --- FIREBASE INITIALIZATION & AUTH ---
    if (firebaseConfig) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    userId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Firebase Auth Error with custom token:", error);
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
            } else {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
            }
            
            document.getElementById('user-id-display').textContent = userId;
            isAuthReady = true;
            initApp(); // Start listeners and draw calendar after auth is ready
        });
    } else {
        // Log "Firebase config is missing."
        console.error("Firebase config is missing."); 
        document.getElementById('user-id-display').textContent = "ERROR: Config missing";
        isAuthReady = true;
        initApp(); 
    }

    // --- FIRESTORE OPERATIONS (No change needed here) ---
    const getUnassignedCollectionRef = () => {
        if (!userId) throw new Error("User not authenticated.");
        return collection(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`);
    };

    const getAssignedCollectionRef = () => {
        if (!userId) throw new Error("User not authenticated.");
        return collection(db, `artifacts/${appId}/users/${userId}/schedule_slots`);
    };
    
    // --- CALENDAR RENDERING ---

    // EXPOSE TO GLOBAL SCOPE
    window.createCalendar = function() {
        calendar.innerHTML = '';
        
        // 1. Day Headers
        calendar.innerHTML += `<div class="cell header bg-gray-200 text-gray-700 text-sm font-normal border-r border-gray-300">Unassigned Tasks</div>`;
        days.forEach(day => {
            calendar.innerHTML += `<div class="cell header bg-green-600 text-white font-bold">${day}</div>`;
        });
        
        // 2. Unassigned Tasks Row (Above the main grid)
        const unassignedRow = document.createElement('div');
        unassignedRow.className = 'col-span-8 p-2 bg-yellow-50 flex flex-wrap gap-2 border-b border-gray-300';
        unassignedRow.id = 'unassigned-tasks-row';
        calendar.appendChild(unassignedRow);

        // 3. Time Slots and Schedule Grid
        times.forEach((time, timeIndex) => {
            // Time Column
            calendar.innerHTML += `<div class="cell time time-slot bg-gray-200 text-gray-700 border-r border-gray-300">${time}</div>`;
            
            // Day/Time Cells
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const slot = document.createElement('div');
                slot.className = 'cell event-slot time-slot border border-gray-200 hover:bg-green-50 transition duration-100';
                slot.id = `slot-${dayIndex}-${timeIndex}`; 
                
                // Event handlers are set below or use window scope when created
                slot.ondrop = window.drop; 
                slot.ondragover = window.allowDrop;
                
                calendar.appendChild(slot);
            }
        });

        window.renderUnassignedTasks();
    };

    // This function must also be exposed if used in initApp()
    window.renderUnassignedTasks = function() {
        // ... (function body remains the same)
        const unassignedRow = document.getElementById('unassigned-tasks-row');
        if (!unassignedRow) return;

        unassignedRow.innerHTML = '';
        
        unassignedTasks.forEach(task => {
            const event = window.createEventElement(task);
            unassignedRow.appendChild(event);
        });
    };

    // This function must also be exposed
    window.createEventElement = function(task) {
        // ... (function body remains the same)
        const event = document.createElement('div');
        event.className = `event p-1 text-xs font-medium text-white shadow-md transition duration-150 transform hover:scale-[1.02] ${task.type === 'Work' ? 'bg-blue-500' : task.type === 'Personal' ? 'bg-pink-500' : 'bg-gray-500'}`;
        event.draggable = true;
        event.ondragstart = window.drag;
        event.id = task.id; // Firestore Document ID
        event.setAttribute('data-name', task.name);
        event.setAttribute('data-type', task.type);
        event.setAttribute('data-timeIndex', task.timeIndex); // Used for location lookup
        event.setAttribute('data-dayIndex', task.dayIndex); // Used for location lookup
        
        event.textContent = `${task.name} (${task.type})`;

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '&times;';
        deleteBtn.className = 'ml-1 text-white opacity-70 hover:opacity-100 float-right';
        deleteBtn.onclick = (e) => {
            e.stopPropagation(); 
            window.deleteEvent(task.id, task.dayIndex, task.timeIndex);
        };
        event.appendChild(deleteBtn);

        return event;
    };
    
    // --- DRAG AND DROP HANDLERS (Already exposed via window.) ---
    // window.allowDrop, window.drag, window.drop are already defined and correct.

    // --- TASK MANAGEMENT (CRUD) ---
    
    // EXPOSE TO GLOBAL SCOPE
    window.addEvent = async function() {
        if (!isAuthReady) return window.showAlert("Wait", "Authentication still loading.");
        
        const name = document.getElementById('event-name').value.trim();
        const type = document.getElementById('event-type').value.trim();
        
        if (!name) return window.showAlert("Missing Info", "Please enter a Task Name.");
        if (!type) return window.showAlert("Missing Info", "Please enter a Task Type.");
        
        try {
            await addDoc(getUnassignedCollectionRef(), {
                name: name,
                type: type
            });

            document.getElementById('event-name').value = '';
            document.getElementById('event-type').value = '';
        } catch (e) {
            console.error("Error adding document: ", e);
            window.showAlert("Error", "Could not save task to database.");
        }
    };

    // EXPOSE TO GLOBAL SCOPE
    window.deleteEvent = async function(id, dayIndex, timeIndex) {
        const confirmed = await window.showAlert(
            "Confirm Delete", 
            "Are you sure you want to delete this task permanently?", 
            true
        );
        if (!confirmed) return;

        try {
            if (dayIndex === -1 && timeIndex === -1) {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`, id));
            } else {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedule_slots`, id));
            }
        } catch (e) {
            console.error("Error deleting document: ", e);
            window.showAlert("Error", "Could not delete task from database.");
        }
    };

    // --- MAIN APPLICATION STARTUP ---

    // This helper function does NOT need to be exposed globally
    function initApp() {
        window.createCalendar(); 
        setupFirestoreListeners();
    }

    // This helper function does NOT need to be exposed globally
    function setupFirestoreListeners() {
        if (!db || !userId) return;

        // ... (Firestore listeners remain the same) ...
        onSnapshot(getAssignedCollectionRef(), (snapshot) => {
            document.querySelectorAll('.event-slot').forEach(slot => slot.innerHTML = '');

            snapshot.docChanges().forEach(change => {
                const task = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'added' || change.type === 'modified') {
                    const slotId = `slot-${task.dayIndex}-${task.timeIndex}`;
                    const targetSlot = document.getElementById(slotId);
                    if (targetSlot) {
                        const eventElement = window.createEventElement(task);
                        targetSlot.appendChild(eventElement);
                    } else {
                         console.warn(`Target slot ${slotId} not found.`);
                    }
                } 
            });
        });

        onSnapshot(getUnassignedCollectionRef(), (snapshot) => {
            unassignedTasks = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                name: doc.data().name, 
                type: doc.data().type,
                dayIndex: -1, 
                timeIndex: -1
            }));
            window.renderUnassignedTasks();
        });
    }
</script>
</body>
</html>
