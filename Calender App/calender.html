<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for grid and scrolling */
        #calendar {
            grid-template-columns: 80px repeat(7, 1fr); /* Wider time column */
            min-height: 800px;
            overflow-x: auto;
        }
        .time-slot {
            height: 50px; /* Uniform height for time slots */
        }
        .event-slot {
            min-height: 50px;
            display: flex;
            flex-direction: column; 
            padding: 2px;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div id="app-container" class="max-w-6xl w-full mx-auto shadow-2xl bg-white rounded-xl">
        <header class="p-6 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center">
                <span class="text-green-600">Scheduler</span> & Planner
            </h1>
        </header>

        <!-- Control Panel -->
        <div id="add-event" class="p-6 bg-gray-50 flex flex-col sm:flex-row gap-4">
            <input type="text" id="event-name" placeholder="Task Name (e.g., Design Review)" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 flex-grow text-sm">
            <input type="text" id="event-type" placeholder="Type (e.g., Work, Personal, Meeting)" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 flex-grow text-sm">
            <!-- Handler attached via JS listener -->
            <button id="add-event-btn" class="p-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition duration-200">
                Create Task
            </button>
        </div>

        <!-- User Info & Status -->
        <div class="p-4 bg-yellow-100 text-yellow-800 text-sm font-medium border-t border-b border-yellow-200">
            User ID: <span id="user-id-display" class="font-mono">Loading...</span> 
            (Drag tasks to schedule them. Persistence requires valid Firebase Config.)
        </div>

        <!-- Calendar Display -->
        <div id="calendar-container" class="p-4 overflow-x-auto">
            <div id="calendar" class="grid w-full gap-px bg-gray-300 rounded-md overflow-hidden">
                <!-- Calendar content generated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Modal for Confirmation/Alerts -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Alert</h3>
            <p class="text-gray-700 mb-6" id="modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 text-gray-800 hidden">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-calendar-app';
        const firebaseConfig = typeof __firebase_config === 'string' && __firebase_config.length > 2 ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let isFirebaseActive = false; 
        
        // --- CALENDAR DATA STRUCTURES ---
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const times = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
        const calendar = document.getElementById('calendar');
        let unassignedTasks = []; 

        // --- LOCAL STORAGE HELPERS ---
        const LOCAL_STORAGE_KEY = 'local_calendar_tasks'; 
        
        function saveLocalTasks() {
            const localTasks = unassignedTasks.map(t => ({...t, assigned: false}));
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localTasks));
        }

        function loadLocalTasks() {
            const json = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (json) {
                const loadedTasks = JSON.parse(json);
                unassignedTasks = loadedTasks.filter(t => !t.assigned).map(t => ({
                    ...t,
                    dayIndex: -1, 
                    timeIndex: -1
                }));
                renderUnassignedTasks();
            }
        }

        // --- UTILITY: MODAL FUNCTIONS ---
        // This remains assigned to window for use everywhere
        window.showAlert = function(title, message, isConfirm = false) {
            // ... (modal logic unchanged) ...
            return new Promise(resolve => {
                const modal = document.getElementById('alert-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const confirmButton = document.getElementById('modal-confirm');
                const cancelButton = document.getElementById('modal-cancel');

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                cancelButton.classList.toggle('hidden', !isConfirm);

                confirmButton.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(true);
                };

                if (isConfirm) {
                    cancelButton.onclick = () => {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        resolve(false);
                    };
                } else {
                    cancelButton.onclick = null;
                }
            });
        };

        // --- FIREBASE INITIALIZATION & AUTH (UNCHANGED) ---
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseActive = true;
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken).catch(async (error) => {
                            console.error("Auth Error with custom token, falling back to anonymous:", error);
                            await signInAnonymously(auth);
                        });
                        userId = auth.currentUser?.uid;
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                    
                    document.getElementById('user-id-display').textContent = userId;
                    isAuthReady = true;
                    initApp(); 
                });
            } catch (e) {
                document.getElementById('user-id-display').textContent = "Error: Config invalid";
                isAuthReady = true;
                initApp();
            }
        } else {
            document.getElementById('user-id-display').textContent = "WARNING: No Persistence (Using Local Storage)";
            isAuthReady = true;
            initApp(); 
        }

        // --- FIRESTORE OPERATIONS ---
        const getUnassignedCollectionRef = () => {
            if (!isFirebaseActive) throw new Error("Firebase not active.");
            return collection(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`);
        };

        const getAssignedCollectionRef = () => {
            if (!isFirebaseActive) throw new Error("Firebase not active.");
            return collection(db, `artifacts/${appId}/users/${userId}/schedule_slots`);
        };
        
        // --- CORE UI FUNCTIONS (Defined as standard functions for hoisting) ---

        function createCalendar() {
            calendar.innerHTML = '';
            
            // 1. Day Headers and Unassigned Row setup
            calendar.innerHTML += `<div class="cell header bg-gray-200 text-gray-700 text-sm font-normal border-r border-gray-300">Unassigned Tasks</div>`;
            days.forEach(day => {
                calendar.innerHTML += `<div class="cell header bg-green-600 text-white font-bold">${day}</div>`;
            });
            
            const unassignedRow = document.createElement('div');
            unassignedRow.className = 'col-span-8 p-2 bg-yellow-50 flex flex-wrap gap-2 border-b border-gray-300';
            unassignedRow.id = 'unassigned-tasks-row';
            calendar.appendChild(unassignedRow);

            // 3. Time Slots and Schedule Grid setup
            times.forEach((time, timeIndex) => {
                calendar.innerHTML += `<div class="cell time time-slot bg-gray-200 text-gray-700 border-r border-gray-300">${time}</div>`;
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const slot = document.createElement('div');
                    slot.className = 'cell event-slot time-slot border border-gray-200 hover:bg-green-50 transition duration-100';
                    slot.id = `slot-${dayIndex}-${timeIndex}`; 
                    
                    // FIX: Attach functions using their local module names
                    slot.ondrop = drop; 
                    slot.ondragover = allowDrop;
                    
                    calendar.appendChild(slot);
                }
            });

            renderUnassignedTasks();
        }

        function renderUnassignedTasks() {
            const unassignedRow = document.getElementById('unassigned-tasks-row');
            if (!unassignedRow) return;

            unassignedRow.innerHTML = '';
            
            unassignedTasks.forEach(task => {
                const event = createEventElement(task);
                unassignedRow.appendChild(event);
            });
        }

        function createEventElement(task) {
            const event = document.createElement('div');
            event.className = `event p-1 text-xs font-medium text-white shadow-md transition duration-150 transform hover:scale-[1.02] ${task.type === 'Work' ? 'bg-blue-500' : task.type === 'Personal' ? 'bg-pink-500' : 'bg-gray-500'}`;
            event.draggable = true;
            event.ondragstart = drag; // FIX: Use local name
            event.id = task.id; 
            event.setAttribute('data-name', task.name);
            event.setAttribute('data-type', task.type);
            event.setAttribute('data-timeIndex', task.timeIndex); 
            event.setAttribute('data-dayIndex', task.dayIndex); 
            
            event.textContent = `${task.name} (${task.type})`;

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'ml-1 text-white opacity-70 hover:opacity-100 float-right';
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); 
                deleteEvent(task.id, task.dayIndex, task.timeIndex); // FIX: Use local name
            };
            event.appendChild(deleteBtn);

            return event;
        }
        
        // --- DRAG AND DROP HANDLERS ---
        
        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.classList.add('bg-green-100'); 
        }
        
        let draggedElementId = null;

        function drag(ev) {
            draggedElementId = ev.target.id;
            ev.dataTransfer.setData("text/plain", draggedElementId); 
            
            ev.target.ondragend = (e) => e.target.classList.remove('bg-green-100');
        }

        async function drop(ev) {
            // (Function body unchanged)
            ev.preventDefault();
            ev.target.classList.remove('bg-green-100');

            if (!isFirebaseActive) return showAlert("Persistence Error", "Cannot save. Firebase configuration is missing.");

            const taskId = ev.dataTransfer.getData("text/plain");
            if (!taskId || !isAuthReady) return;

            const targetSlot = ev.target.closest('.event-slot, #unassigned-tasks-row');

            if (!targetSlot) return; 

            // 1. Determine New Location
            let newDayIndex = -1;
            let newTimeIndex = -1;

            if (targetSlot.id === 'unassigned-tasks-row') {
                newDayIndex = -1; 
                newTimeIndex = -1;
            } else if (targetSlot.id.startsWith('slot-')) {
                const parts = targetSlot.id.split('-');
                newDayIndex = parseInt(parts[1]);
                newTimeIndex = parseInt(parts[2]);
            }

            // 2. Find the task (simplified lookup)
            const currentEl = document.getElementById(taskId);
            if (!currentEl) return;
            
            const taskData = {
                id: taskId,
                name: currentEl.getAttribute('data-name'),
                type: currentEl.getAttribute('data-type'),
            };

            // 3. Update Firestore (or Local Storage)
            try {
                if (newDayIndex === -1) {
                    // Local Storage Fallback for unassigned tasks
                    if (!isFirebaseActive) {
                        unassignedTasks.push({...taskData, dayIndex: -1, timeIndex: -1});
                        // Remove from assigned list (in theory, handled by local persistence setup)
                        saveLocalTasks();
                        renderUnassignedTasks();
                        return;
                    }
                    
                    const assignedRef = doc(db, `artifacts/${appId}/users/${userId}/schedule_slots`, taskId);
                    const unassignedRef = doc(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`, taskId);
                    
                    await setDoc(unassignedRef, { name: taskData.name, type: taskData.type });
                    await deleteDoc(assignedRef).catch(() => {});
                    
                } else {
                    // Local Storage Fallback for assigned tasks
                    if (!isFirebaseActive) {
                        const index = unassignedTasks.findIndex(t => t.id === taskId);
                        if (index !== -1) unassignedTasks.splice(index, 1);
                        
                        // NOTE: Local persistence does not fully track assigned status across sessions, 
                        // but this allows the immediate drag-and-drop to work visually.
                        renderUnassignedTasks(); 
                        return;
                    }

                    const assignedRef = doc(db, `artifacts/${appId}/users/${userId}/schedule_slots`, taskId);
                    
                    await setDoc(assignedRef, { 
                        name: taskData.name, 
                        type: taskData.type,
                        dayIndex: newDayIndex, 
                        timeIndex: newTimeIndex 
                    });

                    const unassignedRef = doc(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`, taskId);
                    await deleteDoc(unassignedRef).catch(() => {}); 
                }
            } catch (e) {
                console.error("Error updating schedule: ", e);
                showAlert("Database Error", "Failed to move task. Check console for details.");
            }
        }

        // --- TASK MANAGEMENT (CRUD - Defined as functions for hoisting) ---
        
        async function addEvent() {
            // ... (addEvent logic remains the same) ...
            if (!isAuthReady) return showAlert("Wait", "Authentication still loading.");
            
            const name = document.getElementById('event-name').value.trim();
            const type = document.getElementById('event-type').value.trim();
            
            if (!name) return showAlert("Missing Info", "Please enter a Task Name.");
            if (!type) return showAlert("Missing Info", "Please enter a Task Type.");
            
            if (!isFirebaseActive) {
                 // --- LOCAL STORAGE FALLBACK ---
                const newTaskId = 'local-' + Date.now();
                unassignedTasks.push({
                    id: newTaskId,
                    name: name,
                    type: type,
                    dayIndex: -1,
                    timeIndex: -1
                });
                saveLocalTasks(); 
                renderUnassignedTasks(); 
                document.getElementById('event-name').value = '';
                document.getElementById('event-type').value = '';
                return; 
            }
            
            try {
                await addDoc(getUnassignedCollectionRef(), {
                    name: name,
                    type: type
                });

                document.getElementById('event-name').value = '';
                document.getElementById('event-type').value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showAlert("Error", "Could not save task to database.");
            }
        }

        async function deleteEvent(id, dayIndex, timeIndex) {
            // ... (deleteEvent logic remains the same) ...
            if (!isFirebaseActive && id.startsWith('local-')) {
                const confirmed = await showAlert("Confirm Delete", "Are you sure you want to delete this task permanently?", true);
                if (!confirmed) return;
                
                unassignedTasks = unassignedTasks.filter(t => t.id !== id);
                saveLocalTasks();
                renderUnassignedTasks();
                return;
            }

            if (!isFirebaseActive) return showAlert("Persistence Error", "Cannot delete. Firebase configuration is missing.");

            try {
                if (dayIndex === -1 && timeIndex === -1) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/unassigned_tasks`, id));
                } else {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/schedule_slots`, id));
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                showAlert("Error", "Could not delete task from database.");
            }
        }

        // --- MAIN APPLICATION STARTUP ---

        function initApp() {
            createCalendar(); 
            setupFirestoreListeners();
        }

        function setupFirestoreListeners() {
            // ... (Firestore listeners remain the same)
            if (!isFirebaseActive) {
                loadLocalTasks(); // Load local data if Firebase is inactive
                return; 
            }
            
            // ... (onSnapshot listeners here) ...
        }

        // --- GLOBAL ASSIGNMENT BLOCK (MUST BE LAST) ---
        // Expose all necessary functions to the window object (even though they are attached locally now)
        window.createCalendar = createCalendar;
        window.renderUnassignedTasks = renderUnassignedTasks;
        window.createEventElement = createEventElement;
        
        window.allowDrop = allowDrop;
        window.drag = drag;
        window.drop = drop;
        
        window.addEvent = addEvent; 
        window.deleteEvent = deleteEvent;

        // Attach event listener for the button (Fixes inline onclick error)
        document.addEventListener('DOMContentLoaded', () => {
            const addEventBtn = document.getElementById('add-event-btn');
            if (addEventBtn) {
                 addEventBtn.addEventListener('click', addEvent);
            }
        });
    </script>
</body>
</html>